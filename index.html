<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Song Association Game</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      color: #333;
    }
    header, main, section, footer {
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    h1, h2, h3 {
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .word-display {
      font-size: 3rem;
      font-weight: bold;
      text-align: center;
      margin: 2rem 0;
    }
    button, select, input[type="text"] {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.8rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .flex-row {
      display: flex;
      gap: 0.5rem;
    }
    .flex-row > * {
      flex: 1;
    }
    .scoreboard {
      border-top: 1px solid #ccc;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    .scoreboard table {
      width: 100%;
      text-align: left;
    }
    .scoreboard td {
      padding: 0.3rem 0;
    }
    .error {
      color: red;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Start Screen -->
    <section id="startScreen">
      <h1>Song Association Game</h1>
      <input id="playerInput" type="text" placeholder="Enter player names, separated by commas" />
      <select id="languageSelect">
        <option value="english">English</option>
        <option value="malay">Malay</option>
        <option value="both">Both</option>
      </select>
      <button onclick="startGame()">Start Game</button>
    </section>

    <!-- Game Screen -->
    <section id="gameScreen" class="hidden">
      <div class="word-display" id="currentWord"></div>
      <select id="scorerSelect">
        <option value="">-- Select Player --</option>
      </select>
      <div class="flex-row">
        <button onclick="submitScore()">Next Word</button>
        <button onclick="skipWord()">Skip Word</button>
      </div>
      <div class="error" id="errorDisplay"></div>
      <button onclick="showSettings()">Settings</button>
    </section>

    <!-- Settings Tab -->
    <section id="settingsScreen" class="hidden">
      <h2>Settings</h2>
      <button onclick="backToGame()">Back to Game</button>
      <input id="addPlayerInput" type="text" placeholder="Add new player name" />
      <button onclick="addPlayer()">Add Player</button>
      <select id="languageSetting">
        <option value="english">English</option>
        <option value="malay">Malay</option>
        <option value="both">Both</option>
      </select>
      <button onclick="refreshWordList()">Refresh Word List</button>
      <button onclick="toggleScoreboard()">Toggle Scoreboard</button>
      <div id="scoreboard" class="scoreboard hidden"></div>
    </section>
  </div>

  <script>
    let players = [];
    let scores = {};
    let words = { english: [], malay: [] };
    let currentLanguage = 'english';
    let currentIndex = 0;
    let altLangFlag = true;

    const startGame = () => {
      players = document.getElementById('playerInput').value.split(',').map(p => p.trim()).filter(Boolean);
      currentLanguage = document.getElementById('languageSelect').value;
      if (players.length === 0) return alert('Enter at least one player');

      players.forEach(p => scores[p] = 0);
      populateScorerDropdown();
      refreshWordList(true);

      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('hidden');
    };

    const populateScorerDropdown = () => {
      const scorerSelect = document.getElementById('scorerSelect');
      scorerSelect.innerHTML = '<option value="">-- Select Player --</option>';
      players.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        scorerSelect.appendChild(opt);
      });
    };

    const showSettings = () => {
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('settingsScreen').classList.remove('hidden');
      document.getElementById('languageSetting').value = currentLanguage;
    };

    const backToGame = () => {
      document.getElementById('settingsScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('hidden');
    };

    const addPlayer = () => {
      const newName = document.getElementById('addPlayerInput').value.trim();
      if (newName && !players.includes(newName)) {
        players.push(newName);
        scores[newName] = 0;
        populateScorerDropdown();
      }
      document.getElementById('addPlayerInput').value = '';
    };

    const refreshWordList = async (autoStart = false) => {
      try {
        const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5MX7qFT32Er41i6EPORV5GH9xsIlh6nwNxsV9_qGTL6PHvDBvNb9I5PhlTycbQyb5-f9ffg4BE5FB/pub?output=csv');
        const csv = await res.text();
        const lines = csv.trim().split('\n');
        const [header, ...data] = lines.map(line => line.split(','));
        const engIndex = header.indexOf('english');
        const malayIndex = header.indexOf('malay');

        words.english = data.map(row => row[engIndex]).filter(Boolean);
        words.malay = data.map(row => row[malayIndex]).filter(Boolean);

        if (autoStart) generateWord();
      } catch (e) {
        alert('Failed to load word list');
      }
    };

    const generateWord = () => {
      document.getElementById('errorDisplay').textContent = '';
      const lang = currentLanguage === 'both' ? (altLangFlag ? 'english' : 'malay') : currentLanguage;
      altLangFlag = !altLangFlag;
      const pool = words[lang];
      const randomIndex = Math.floor(Math.random() * pool.length);
      document.getElementById('currentWord').textContent = pool[randomIndex] || '[No Word]';
    };

    const submitScore = () => {
      const name = document.getElementById('scorerSelect').value;
      if (!name) {
        document.getElementById('errorDisplay').textContent = 'Select a player before generating the next word.';
        return;
      }
      scores[name] += 1;
      document.getElementById('scorerSelect').value = '';
      generateWord();
    };

    const skipWord = () => {
      document.getElementById('scorerSelect').value = '';
      document.getElementById('errorDisplay').textContent = '';
      generateWord();
    };

    const toggleScoreboard = () => {
      const sb = document.getElementById('scoreboard');
      sb.classList.toggle('hidden');
      if (!sb.classList.contains('hidden')) {
        let html = '<h3>Scoreboard</h3><table>';
        players.forEach(p => {
          html += `<tr><td>${p}</td><td>${scores[p]}</td>
          <td><button onclick="adjustScore('${p}', 1)">+</button></td>
          <td><button onclick="adjustScore('${p}', -1)">-</button></td></tr>`;
        });
        html += '</table>';
        sb.innerHTML = html;
      } else {
        sb.innerHTML = '';
      }
    };

    const adjustScore = (player, delta) => {
      scores[player] += delta;
      toggleScoreboard();
      toggleScoreboard(); // refresh scoreboard UI
    };

    document.getElementById('languageSetting').addEventListener('change', (e) => {
      currentLanguage = e.target.value;
    });
  </script>
</body>
</html>
