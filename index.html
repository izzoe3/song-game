<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.ico" />
  <title>Song Association Game</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f8fafc;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header, nav, main {
      padding: 1rem;
    }
    header {
      background-color: #0f172a;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background-color: #e2e8f0;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      background: none;
      border: none;
      font-size: 1rem;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    button {
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #0f172a;
      color: white;
      cursor: pointer;
    }
    input, select {
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
    }
    .scoreboard {
      margin-top: 1rem;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Song Association Game</h1>
  </header>
  <nav>
    <button onclick="switchTab('game')">Game</button>
    <button onclick="switchTab('settings')">Settings</button>
  </nav>
  <main>
    <section id="game" class="tab-content active">
      <div class="centered">
        <div id="startScreen">
          <input id="playerNames" placeholder="Enter player names (comma separated)" />
          <select id="languageSelect">
            <option value="english">English</option>
            <option value="malay">Malay</option>
            <option value="both">Both</option>
          </select>
          <button onclick="startGame()">Start Game</button>
        </div>
        <div id="gameScreen" class="hidden">
          <h2 id="currentWord">...</h2>
          <p>Current Player: <span id="currentPlayer"></span></p>
          <button onclick="nextWord()">Next Word</button>
        </div>
      </div>
    </section>
    <section id="settings" class="tab-content">
      <div class="centered">
        <button onclick="resetGame()">Restart Game</button>
        <button onclick="refreshWords()">Refresh Word List</button>
        <select id="settingsLanguage" onchange="changeLanguage(this.value)">
          <option value="english">English</option>
          <option value="malay">Malay</option>
          <option value="both">Both</option>
        </select>
        <button onclick="toggleScoreboard()">Toggle Leaderboard</button>
        <div id="scoreboard" class="scoreboard hidden"></div>
      </div>
    </section>
  </main>
  <script>
    let englishWords = [];
    let malayWords = [];
    let combinedWords = [];
    let players = [];
    let scores = {};
    let currentIndex = 0;
    let currentPlayerIndex = 0;
    let currentLang = 'english';

    async function fetchWords() {
      const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5MX7qFT32Er41i6EPORV5GH9xsIlh6nwNxsV9_qGTL6PHvDBvNb9I5PhlTycbQyb5-f9ffg4BE5FB/pub?output=csv';
      const res = await fetch(sheetURL);
      const data = await res.text();
      const rows = data.split('\n');
      englishWords = [];
      malayWords = [];
      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(',');
        if (cols[0]) englishWords.push(cols[0].trim());
        if (cols[1]) malayWords.push(cols[1].trim());
      }
    }

    function startGame() {
      const nameInput = document.getElementById('playerNames').value;
      players = nameInput.split(',').map(n => n.trim()).filter(n => n);
      scores = Object.fromEntries(players.map(p => [p, 0]));
      currentLang = document.getElementById('languageSelect').value;
      localStorage.setItem('language', currentLang);
      combinedWords = currentLang === 'english' ? [...englishWords] : currentLang === 'malay' ? [...malayWords] : [...englishWords, ...malayWords];
      shuffle(combinedWords);
      currentIndex = 0;
      currentPlayerIndex = 0;
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('hidden');
      nextWord();
    }

    function nextWord() {
      if (combinedWords.length === 0) return;
      if (currentIndex >= combinedWords.length) currentIndex = 0;
      const word = combinedWords[currentIndex++];
      document.getElementById('currentWord').textContent = word;
      document.getElementById('currentPlayer').textContent = players[currentPlayerIndex];
      currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
    }

    function resetGame() {
      localStorage.clear();
      location.reload();
    }

    function changeLanguage(lang) {
      currentLang = lang;
      document.getElementById('languageSelect').value = lang;
    }

    function toggleScoreboard() {
      const el = document.getElementById('scoreboard');
      if (el.classList.contains('hidden')) {
        el.innerHTML = players.map(p => `<p>${p}: ${scores[p] || 0}</p>`).join('');
        el.classList.remove('hidden');
      } else {
        el.classList.add('hidden');
      }
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    async function refreshWords() {
      await fetchWords();
      alert('Word list updated!');
    }

    window.addEventListener('load', async () => {
      await fetchWords();
      const savedLang = localStorage.getItem('language');
      if (savedLang) {
        document.getElementById('languageSelect').value = savedLang;
        document.getElementById('settingsLanguage').value = savedLang;
      }
    });
  </script>
</body>
</html>
