<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Association Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0e4ff, #ffe4e1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 600px;
            width: 90%;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .tab-button {
            flex: 1;
            padding: 12px;
            font-size: 18px;
            font-weight: 600;
            background-color: #e0e0e0;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-button.active {
            background-color: #20c997;
            color: white;
        }
        .tab-button:hover, .tab-button:active {
            background-color: #17a589;
            color: white;
        }
        h1 {
            color: #2d3748;
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
        }
        select, button, input {
            margin: 10px auto;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        button {
            background-color: #ff6b6b;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            min-height: 48px;
        }
        button:hover, button:active {
            background-color: #e65b5b;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.score-btn {
            width: 48px;
            display: inline-block;
            margin: 5px;
            font-size: 14px;
        }
        #wordDisplay {
            font-size: 36px;
            font-weight: 600;
            color: #2d3748;
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 10px;
        }
        #feedback {
            margin-top: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
        }
        #feedback.green {
            color: #28a745;
        }
        #feedback.red {
            color: #dc3545;
        }
        #leaderboard {
            margin-top: 20px;
            text-align: left;
            display: none;
        }
        #leaderboard h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #2d3748;
        }
        #leaderboard ul {
            list-style: none;
            padding: 0;
        }
        #leaderboard li {
            font-size: 16px;
            margin: 8px 0;
            color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content input, .modal-content select {
            margin: 10px auto;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 20px;
            }
            #wordDisplay {
                font-size: 32px;
                padding: 15px;
            }
            select, button, input {
                font-size: 14px;
                padding: 10px;
            }
            .tab-button {
                font-size: 16px;
            }
            button.score-btn {
                width: 40px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <h2>Setup Game</h2>
            <input type="text" id="playerInput" placeholder="Enter player names (e.g., Ali, Siti)">
            <select id="languageSelect">
                <option value="en">English</option>
                <option value="ms">Malay</option>
                <option value="both">Both</option>
            </select>
            <p>Words are loaded from a Google Sheet. Add new words there and click "Refresh Word List" in Settings.</p>
            <button onclick="startGame()">Start Game</button>
        </div>
    </div>
    <div class="container">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('game')">Game</button>
            <button class="tab-button" onclick="showTab('settings')">Settings</button>
        </div>
        <div id="gameTab" class="tab-content">
            <h1>Song Association Game</h1>
            <div id="wordDisplay"></div>
            <select id="playerSelect" onchange="enableGenerateButton()">
                <option value="">Select Player</option>
            </select>
            <button id="generateWordBtn" onclick="generateWord()" disabled>Generate New Word</button>
            <button onclick="skipWord()">Skip Word</button>
            <select id="languageChangeSelect" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="ms">Malay</option>
                <option value="both">Both</option>
            </select>
            <div id="feedback"></div>
        </div>
        <div id="settingsTab" class="tab-content" style="display: none;">
            <h1>Settings</h1>
            <input type="text" id="addPlayerInput" placeholder="Enter new player name">
            <button onclick="addPlayer()">Add Player</button>
            <select id="removePlayerSelect">
                <option value="">Select Player to Remove</option>
            </select>
            <button onclick="removePlayer()">Remove Player</button>
            <button onclick="refreshWordList()">Refresh Word List</button>
            <button id="toggleLeaderboard" onclick="toggleLeaderboard()">Show Leaderboard</button>
            <div id="leaderboard">
                <h2>Leaderboard</h2>
                <ul id="leaderboardList"></ul>
            </div>
            <div id="feedbackSettings"></div>
        </div>
    </div>

    <script>
        let players = {};
        let currentWord = '';
        let languageMode = 'en';
        let useEnglish = true;
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5MX7qFT32Er41i6EPORV5GH9xsIlh6nwNxsV9_qGTL6PHvDBvNb9I5PhlTycbQyb5-f9ffg4BE5FB/pub?output=csv';
        let wordLists = { english: [], malay: [] };

        // Show setup modal on page load
        document.getElementById('playerModal').style.display = 'flex';

        function showTab(tabName) {
            document.getElementById('gameTab').style.display = tabName === 'game' ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = tabName === 'settings' ? 'block' : 'none';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedbackSettings').textContent = '';
            enableGenerateButton();
        }

        async function fetchWords() {
            const feedback = document.getElementById('feedbackSettings') || document.getElementById('feedback');
            try {
                const response = await fetch(sheetUrl);
                if (!response.ok) throw new Error(`HTTP error ${response.status}: Failed to fetch Google Sheet`);
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                wordLists.malay = rows.slice(1).map(row => row[0]).filter(word => word && word !== '');
                wordLists.english = rows.slice(1).map(row => row[1]).filter(word => word && word !== '');
                if (wordLists.malay.length === 0 && wordLists.english.length === 0) {
                    throw new Error('No valid words found in the Google Sheet');
                }
                feedback.textContent = 'Word list loaded successfully!';
                feedback.className = 'green';
                return true;
            } catch (error) {
                console.error('Error:', error);
                feedback.textContent = 'Error: Could not load Google Sheet. Ensure it’s published as CSV and set to "Anyone with the link" (Viewer).';
                feedback.className = 'red';
                return false;
            }
        }

        async function startGame() {
            const playerInput = document.getElementById('playerInput').value.trim();
            languageMode = document.getElementById('languageSelect').value;
            if (!playerInput) {
                alert('Please enter at least one player name.');
                return;
            }
            const playerNames = playerInput.split(',').map(name => name.trim()).filter(name => name);
            if (playerNames.length === 0) {
                alert('Please enter valid player names.');
                return;
            }
            const wordsLoaded = await fetchWords();
            if (!wordsLoaded) {
                document.getElementById('wordDisplay').textContent = 'Error: No words available.';
                document.getElementById('feedback').textContent = 'No words available. Add words to the Google Sheet and click "Refresh Word List" in Settings.';
                document.getElementById('feedback').className = 'red';
                return;
            }
            playerNames.forEach(name => {
                players[name] = 0;
            });
            updatePlayerSelect();
            updateRemovePlayerSelect();
            updateLeaderboard();
            document.getElementById('languageChangeSelect').value = languageMode;
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('gameTab').style.display = 'block';
            // Generate initial word after confirming word lists are populated
            const availableWords = languageMode === 'en' ? wordLists.english : languageMode === 'ms' ? wordLists.malay : [...wordLists.english, ...wordLists.malay];
            if (availableWords.length > 0) {
                generateWord();
            } else {
                document.getElementById('wordDisplay').textContent = 'Error: No words available.';
                document.getElementById('feedback').textContent = `No ${languageMode === 'en' ? 'English' : languageMode === 'ms' ? 'Malay' : 'words'} available. Add words to the Google Sheet and click "Refresh Word List" in Settings.`;
                document.getElementById('feedback').className = 'red';
            }
        }

        async function refreshWordList() {
            const feedback = document.getElementById('feedbackSettings');
            feedback.textContent = 'Refreshing word list...';
            feedback.className = '';
            const success = await fetchWords();
            if (success) {
                feedback.textContent = 'Word list refreshed! Return to Game tab to continue.';
                feedback.className = 'green';
                generateWord(); // Generate new word after refresh
            }
        }

        function updatePlayerSelect() {
            const playerSelect = document.getElementById('playerSelect');
            const previousValue = playerSelect.value;
            playerSelect.innerHTML = '<option value="">Select Player</option>';
            Object.keys(players).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                playerSelect.appendChild(option);
            });
            playerSelect.value = previousValue && players[previousValue] ? previousValue : '';
            enableGenerateButton();
        }

        function updateRemovePlayerSelect() {
            const removePlayerSelect = document.getElementById('removePlayerSelect');
            removePlayerSelect.innerHTML = '<option value="">Select Player to Remove</option>';
            Object.keys(players).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                removePlayerSelect.appendChild(option);
            });
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            Object.entries(players).sort((a, b) => b[1] - a[1]).forEach(([name, score]) => {
                const li = document.createElement('li');
                li.innerHTML = `${name}: ${score} points <button class="score-btn" onclick="incrementScore('${name}')">+</button><button class="score-btn" onclick="decrementScore('${name}')">–</button>`;
                leaderboardList.appendChild(li);
            });
        }

        function incrementScore(player) {
            players[player] += 1;
            updateLeaderboard();
            updatePlayerSelect();
            document.getElementById('feedbackSettings').textContent = `Added 1 point to ${player}.`;
            document.getElementById('feedbackSettings').className = 'green';
        }

        function decrementScore(player) {
            if (players[player] > 0) {
                players[player] -= 1;
                updateLeaderboard();
                updatePlayerSelect();
                document.getElementById('feedbackSettings').textContent = `Removed 1 point from ${player}.`;
                document.getElementById('feedbackSettings').className = 'green';
            } else {
                document.getElementById('feedbackSettings').textContent = `${player} already has 0 points.`;
                document.getElementById('feedbackSettings').className = 'red';
            }
        }

        function toggleLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            const button = document.getElementById('toggleLeaderboard');
            if (leaderboard.style.display === 'none') {
                leaderboard.style.display = 'block';
                button.textContent = 'Hide Leaderboard';
            } else {
                leaderboard.style.display = 'none';
                button.textContent = 'Show Leaderboard';
            }
        }

        function enableGenerateButton() {
            const player = document.getElementById('playerSelect').value;
            const generateBtn = document.getElementById('generateWordBtn');
            generateBtn.disabled = !player;
        }

        function generateWord() {
            const player = document.getElementById('playerSelect').value;
            const feedback = document.getElementById('feedback');
            const generateBtn = document.getElementById('generateWordBtn');

            if (!player) {
                feedback.textContent = 'Please select a player to generate a new word.';
                feedback.className = 'red';
                generateBtn.disabled = true;
                return;
            }

            players[player] += 1;
            feedback.textContent = `Nice singing, ${player}! You earn 1 point!`;
            feedback.className = 'green';

            let lang = languageMode;
            if (languageMode === 'both') {
                lang = useEnglish ? 'en' : 'ms';
                useEnglish = !useEnglish;
            }
            const wordList = lang === 'en' ? wordLists.english : wordLists.malay;
            if (wordList.length === 0) {
                document.getElementById('wordDisplay').textContent = 'Error: No words available.';
                document.getElementById('feedback').textContent = `No ${lang === 'en' ? 'English' : 'Malay'} words available. Add words to the Google Sheet and click "Refresh Word List" in Settings.`;
                document.getElementById('feedback').className = 'red';
                generateBtn.disabled = true;
                return;
            }
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            document.getElementById('wordDisplay').textContent = currentWord;
            document.getElementById('playerSelect').value = '';
            generateBtn.disabled = true;
            updateLeaderboard();
        }

        function skipWord() {
            let wordList;
            if (languageMode === 'both') {
                wordList = Math.random() < 0.5 ? wordLists.english : wordLists.malay;
            } else {
                wordList = languageMode === 'en' ? wordLists.english : wordLists.malay;
            }
            if (wordList.length === 0) {
                document.getElementById('wordDisplay').textContent = 'Error: No words available.';
                document.getElementById('feedback').textContent = `No ${languageMode === 'en' ? 'English' : languageMode === 'ms' ? 'Malay' : 'words'} available. Add words to the Google Sheet and click "Refresh Word List" in Settings.`;
                document.getElementById('feedback').className = 'red';
                document.getElementById('generateWordBtn').disabled = true;
                return;
            }
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            document.getElementById('wordDisplay').textContent = currentWord;
            document.getElementById('playerSelect').value = '';
            document.getElementById('generateWordBtn').disabled = true;
            document.getElementById('feedback').textContent = 'Word skipped! New word generated.';
            document.getElementById('feedback').className = 'green';
        }

        function addPlayer() {
            const newPlayer = document.getElementById('addPlayerInput').value.trim();
            const feedback = document.getElementById('feedbackSettings');
            if (!newPlayer) {
                feedback.textContent = 'Please enter a player name to add.';
                feedback.className = 'red';
                return;
            }
            if (players[newPlayer]) {
                feedback.textContent = `Player "${newPlayer}" already exists.`;
                feedback.className = 'red';
                return;
            }
            players[newPlayer] = 0;
            updatePlayerSelect();
            updateRemovePlayerSelect();
            updateLeaderboard();
            document.getElementById('addPlayerInput').value = '';
            feedback.textContent = `Player "${newPlayer}" added!`;
            feedback.className = 'green';
        }

        function removePlayer() {
            const playerToRemove = document.getElementById('removePlayerSelect').value;
            const feedback = document.getElementById('feedbackSettings');
            if (!playerToRemove) {
                feedback.textContent = 'Please select a player to remove.';
                feedback.className = 'red';
                return;
            }
            delete players[playerToRemove];
            updatePlayerSelect();
            updateRemovePlayerSelect();
            updateLeaderboard();
            feedback.textContent = `Player "${playerToRemove}" removed!`;
            feedback.className = 'green';
        }

        function changeLanguage() {
            languageMode = document.getElementById('languageChangeSelect').value;
            useEnglish = true; // Reset alternation for "Both" mode
            document.getElementById('feedback').textContent = `Language changed to ${languageMode === 'en' ? 'English' : languageMode === 'ms' ? 'Malay' : 'Both'}.`;
            document.getElementById('feedback').className = 'green';
            generateWord(); // Generate new word on language change
        }
    </script>
</body>
</html>