<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Song Association Game</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #212529;
    }
    .container {
      max-width: 500px;
      margin: auto;
      padding: 2rem;
    }
    .hidden { display: none; }
    h1 { font-size: 1.5rem; text-align: center; }
    .word-display {
      font-size: 3rem;
      font-weight: bold;
      text-align: center;
      margin: 2rem 0;
    }
    .btn {
      display: inline-block;
      margin: 0.5rem;
      padding: 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.5rem;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    .btn:hover { background: #0056b3; }
    select, input[type=text] {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
    }
    .settings, .scoreboard-section { margin-top: 2rem; }
    .error { color: red; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <div id="start-screen">
      <h1>Start Game</h1>
      <input type="text" id="player-input" placeholder="Enter player names, comma separated" />
      <select id="language-select">
        <option value="english">English</option>
        <option value="malay">Malay</option>
        <option value="both">Both</option>
      </select>
      <button class="btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="game-screen" class="hidden">
      <div class="word-display" id="word-display">[No Word]</div>
      <select id="scoring-player">
        <option value="">-- Select Player to Score --</option>
      </select>
      <div class="error" id="score-error"></div>
      <button class="btn" onclick="nextWord(true)">Submit Score + Next Word</button>
      <button class="btn" onclick="nextWord(false)">Skip Word</button>
      <button class="btn" onclick="toggleSettings()">Settings</button>
    </div>

    <div id="settings-screen" class="hidden">
      <div class="settings">
        <h2>Settings</h2>
        <button class="btn" onclick="toggleScoreboard()">Toggle Scoreboard</button>
        <div id="scoreboard" class="hidden scoreboard-section"></div>
        <button class="btn" onclick="resetGame()">Reset Game</button>
        <button class="btn" onclick="fetchWords()">Refresh Word List</button>
      </div>
    </div>
  </div>

  <script>
    let players = [];
    let scores = {};
    let words = [];
    let currentWord = '';
    let langMode = 'english';
    let lastLang = '';

    const SHEET_ID = 'YOUR_SHEET_ID';
    const SHEET_GID = '0';

    async function fetchWords() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`;
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const header = rows[0];
      const englishIdx = header.indexOf('english');
      const malayIdx = header.indexOf('malay');
      const english = [], malay = [];
      for (let i = 1; i < rows.length; i++) {
        if (englishIdx >= 0 && rows[i][englishIdx]) english.push(rows[i][englishIdx]);
        if (malayIdx >= 0 && rows[i][malayIdx]) malay.push(rows[i][malayIdx]);
      }
      words = { english, malay };
      if (langMode !== 'both') {
        currentWord = getRandomWord(langMode);
        document.getElementById('word-display').textContent = currentWord;
      }
    }

    function getRandomWord(lang) {
      if (!words[lang] || words[lang].length === 0) return '[No Word]';
      return words[lang][Math.floor(Math.random() * words[lang].length)];
    }

    function startGame() {
      players = document.getElementById('player-input').value.split(',').map(p => p.trim()).filter(p => p);
      langMode = document.getElementById('language-select').value;
      if (players.length === 0) return alert('Add at least one player!');

      scores = {};
      players.forEach(p => scores[p] = 0);
      updateScoreboard();
      const playerSelect = document.getElementById('scoring-player');
      playerSelect.innerHTML = '<option value="">-- Select Player to Score --</option>' +
        players.map(p => `<option value="${p}">${p}</option>`).join('');

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      fetchWords();
    }

    function nextWord(addScore) {
      const player = document.getElementById('scoring-player').value;
      const errorBox = document.getElementById('score-error');
      errorBox.textContent = '';

      if (addScore && !player) {
        errorBox.textContent = 'Please select a player before continuing!';
        return;
      }
      if (addScore) scores[player]++;

      if (langMode === 'both') {
        const newLang = (lastLang === 'english') ? 'malay' : 'english';
        currentWord = getRandomWord(newLang);
        lastLang = newLang;
      } else {
        currentWord = getRandomWord(langMode);
      }
      document.getElementById('word-display').textContent = currentWord || '[No Word]';
      document.getElementById('scoring-player').value = '';
    }

    function updateScoreboard() {
      const scoreboard = document.getElementById('scoreboard');
      scoreboard.innerHTML = '';
      for (const player of players) {
        scoreboard.innerHTML += `
          <div>
            ${player}: <input type="number" value="${scores[player]}" onchange="scores['${player}'] = parseInt(this.value) || 0" />
          </div>
        `;
      }
    }

    function toggleSettings() {
      document.getElementById('settings-screen').classList.toggle('hidden');
    }

    function toggleScoreboard() {
      const el = document.getElementById('scoreboard');
      el.classList.toggle('hidden');
      updateScoreboard();
    }

    function resetGame() {
      localStorage.clear();
      location.reload();
    }
  </script>
</body>
</html>
